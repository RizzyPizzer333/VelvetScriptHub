<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Velvet Script Hub</title>

<style>
:root {
  --bg: rgba(0,0,0,0);
  --card: #282828;
  --border: #404040;
  --text: #e0e0e0;
  --text-dim: #a0a0a0;
  --hover: #333;
  --saved: #00d4ff;
  --radius: 6px;
}
*{margin:0;padding:0;box-sizing:border-box;}

body{
  background:var(--bg);
  color:var(--text);
  font-family:"Segoe UI",sans-serif;
  padding:20px;
  min-height:100vh;
  backdrop-filter: blur(20px);
}

/* Scrollable grid */
.script-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:16px;
  max-height:75vh;
  overflow-y:auto;
  padding-right:6px;
}
.script-grid::-webkit-scrollbar{width:8px;}
.script-grid::-webkit-scrollbar-track{background:#1e1e1e;border-radius:4px;}
.script-grid::-webkit-scrollbar-thumb{background:#666;border-radius:4px;}
.script-grid::-webkit-scrollbar-thumb:hover{background:#999;}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  overflow:hidden;
  transition:.2s;
}
.card:hover{background:var(--hover);border-color:#666;}
.card img{width:100%;height:120px;object-fit:cover;}
.card-body{padding:12px;display:flex;flex-direction:column;gap:6px;flex:1;}
.card-title{font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.card-meta{color:var(--text-dim);font-size:12px;}
.card-actions{margin-top:auto;display:flex;gap:6px;}

.btn{
  flex:1;padding:6px;border-radius:var(--radius);
  background:transparent;border:1px solid var(--border);
  color:var(--text);cursor:pointer;font-size:13px;
  display:flex;align-items:center;justify-content:center;gap:4px;
  transition:.2s;
}
.btn:hover{background:#404040;border-color:#666;}
.save-btn.active svg{fill:var(--saved);}

/* Toast always top */
.toast{
  position:fixed;
  bottom:25px;
  right:25px;
  background:#333;
  color:white;
  padding:14px 22px;
  border-radius:var(--radius);
  opacity:0;
  transform:translateY(20px);
  transition:.18s;
  z-index:999999999;
  display:flex;
  align-items:center;
  gap:10px;
  box-shadow:0 8px 25px rgba(0,0,0,0.5);
}
.toast.show{opacity:1;transform:translateY(0);}
.toast svg{width:18px;height:18px;fill:#4ade80;}

.empty{text-align:center;padding:60px 20px;color:var(--text-dim);font-size:16px;}
</style>
</head>

<body>
<div class="container">

  <div class="header">
    <div class="search">
      <input id="searchInput" placeholder="Search scripts...">
    </div>
  </div>

  <div class="tab-bar">
    <div class="tab active" data-tab="cloud">Cloud Scripts</div>
    <div class="tab" data-tab="saved">Saved (<span id="savedCount">0</span>)</div>
  </div>

  <div id="cloud" class="script-grid"></div>
  <div id="saved" class="script-grid" style="display:none"></div>
</div>

<div class="toast" id="toast">
  <svg viewBox="0 0 24 24"><path d="M9 16.17 4.83 12 3.41 13.41 9 19l12-12-1.41-1.41z"/></svg>
  <span id="toastText">Copied!</span>
</div>

<script>
const $ = id => document.getElementById(id);
const PROXY = "https://api.allorigins.win/raw?url=";

let allScripts = [];
let searchQuery = "";
let currentPage = 1;
let loading = false;
let endReached = false;

/* --- Toast Fix --- */
function showToast(t){
  $("toastText").textContent = t;
  $("toast").classList.add("show");
  clearTimeout(window.toastTimeout);
  window.toastTimeout = setTimeout(() => $("toast").classList.remove("show"), 2000);
}

/* --- Saved --- */
const getSaved = () => JSON.parse(localStorage.getItem("savedScripts")||"[]");
const setSaved = d => localStorage.setItem("savedScripts", JSON.stringify(d));
const findId = s => s.id || s._id || s.scriptId || s.slug || s.title;

/* --- Fetch raw script --- */
async function fetchRaw(id){
  try{
    const res = await fetch(PROXY + encodeURIComponent("https://scriptblox.com/api/script/raw/" + id));
    const json = await res.json();
    return json.script?.script || json.script || "";
  }catch{return "";}
}

/* --- Copy button --- */
async function copyScript(scr){
  const raw = scr.script || await fetchRaw(findId(scr));
  navigator.clipboard.writeText(raw);
  showToast("Copied!");
}

/* --- Save button --- */
async function toggleSave(scr, btn){
  const id = findId(scr);
  let saved = getSaved();
  const ix = saved.findIndex(x => findId(x) === id);

  if(ix >= 0){
    saved.splice(ix, 1);
    btn.classList.remove("active");
    showToast("Removed");
  } else {
    const raw = scr.script || await fetchRaw(id);
    saved.push({...scr, script: raw});
    btn.classList.add("active");
    showToast("Saved!");
  }
  setSaved(saved);
  $("savedCount").textContent = saved.length;
  if(currentTab === "saved") render();
}

/* --- Render --- */
let currentTab = "cloud";
function render(){
  const list = currentTab === "cloud" ? allScripts : getSaved();
  const box = $(currentTab);
  box.innerHTML = "";

  if(!list.length){
    box.innerHTML = `<div class="empty">No scripts found</div>`;
    return;
  }

  list.forEach(s=>{
    const c = document.createElement("div"); c.className="card";
    const img = document.createElement("img");
    img.src = s.image || "NoImg.png";

    const body = document.createElement("div");
    body.className = "card-body";

    body.innerHTML = `
      <div class="card-title">${s.title || "Untitled"}</div>
      <div class="card-meta">${s.game?.name || "Universal"}</div>
    `;

    const actions = document.createElement("div");
    actions.className = "card-actions";

    const save = document.createElement("button");
    save.className = "btn save-btn";
    if(getSaved().some(x=> findId(x) === findId(s))) save.classList.add("active");
    save.innerHTML = `<svg viewBox="0 0 24 24"><path d="M17 3H7c-1 0-2 .9-2 2v14l7-3 7 3V5c0-1-.9-2-2-2z"/></svg>`;
    save.onclick = e=>{e.stopPropagation();toggleSave(s,save);};

    const copy = document.createElement("button");
    copy.className = "btn";
    copy.innerHTML = `Copy`;
    copy.onclick = e=>{e.stopPropagation();copyScript(s);};

    actions.appendChild(save);
    actions.appendChild(copy);
    body.appendChild(actions);

    c.appendChild(img);
    c.appendChild(body);
    box.appendChild(c);
  });
}

/* --- Infinite Scroll Load --- */
async function loadScripts(){
  if(loading || endReached) return;
  loading = true;

  let url = searchQuery
    ? `https://scriptblox.com/api/script/search?q=${encodeURIComponent(searchQuery)}&page=${currentPage}`
    : `https://scriptblox.com/api/script/fetch?page=${currentPage}`;

  try{
    const res = await fetch(PROXY + encodeURIComponent(url));
    const json = await res.json();

    const newData =
      json.result?.scripts ||
      json.scripts ||
      json.result?.data ||
      [];

    if(!newData.length){
      endReached = true;
      loading = false;
      return;
    }

    allScripts.push(...newData);
    render();
    currentPage++;
  }
  catch(e){
    showToast("Failed to load API");
  }

  loading = false;
}

/* --- Scroll Event --- */
$("cloud").addEventListener("scroll", function(){
  if(this.scrollTop + this.clientHeight >= this.scrollHeight - 50){
    loadScripts();
  }
});

/* --- Tabs --- */
document.querySelectorAll(".tab").forEach(t=>{
  t.onclick = ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");

    currentTab = t.dataset.tab;
    $("cloud").style.display = currentTab==="cloud" ? "grid" : "none";
    $("saved").style.display = currentTab==="saved" ? "grid" : "none";
    render();
  };
});

/* --- Search --- */
$("searchInput").oninput = e=>{
  searchQuery = e.target.value.trim();
  allScripts = [];
  currentPage = 1;
  endReached = false;
  loadScripts();
};

/* --- Init --- */
$("savedCount").textContent = getSaved().length;
loadScripts();

</script>
</body>
</html>
